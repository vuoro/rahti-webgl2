<!DOCTYPE html>
<html>
  <head>
    <script defer src="https://unpkg.com/es-module-shims@0.10.1/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@vuoro/rahti": "https://cdn.skypack.dev/@vuoro/rahti"
        }
      }
    </script>
  </head>

  <body>
    <canvas id="canvas"></canvas>

    <script type="module">
      import { effect, state } from "@vuoro/rahti";
      import {
        context,
        uniformBlock,
        attribute,
        elements,
        instances,
        command,
        texture,
      } from "./main.js";

      // is API for resources ok?
      // and for commands?
      // write each piece of the API

      const graphics = effect(() => {
        const thisContext = context(document.getElementById("canvas"));

        const shape = attribute(thisContext, [
          Float32Array.of(0, 0),
          Float32Array.of(1, 0),
          Float32Array.of(1, 1),
          Float32Array.of(0, 1),
        ]);
        const shared = uniformBlock(thisContext, { time: 0, lightColor: [0, 0, 0] });
        const smallTexture = texture(thisContext, {});

        const triangleElements = elements(thisContext, Int16Array.of(0, 1, 2));
        const quadElements = elements(thisContext, Int16Array.of(0, 1, 2, 2, 3, 0));

        const quadInstance = instances(thisContext, { color: [0, 0, 0], offset: [0, 0] });

        const drawTriangle = command(thisContext, {
          attributes: { shape },
          uniformBlocks: { shared },
          textures: { smallTexture },
          // elements: triangleElements,
          vertex: `
            void main () {
              gl_Position = vec4(shape, 0.0, 1.0);
            }
          `,
          fragment: `
            out vec4 fragment;

            void main () {
              fragment = vec4(1.0, 0.0, 0.0, 1.0);
            }
          `,
        });

        const drawQuad = command(thisContext, {
          attributes: { shape },
          uniformBlocks: { shared },
          textures: { smallTexture },
          elements: quadElements,
          instances: quadInstance,
          vertex: `
            out vec3 colorOut;

            void main () {
              colorOut = color;
              gl_Position = vec4(shape + offset, 0.0, 1.0);
            }
          `,
          fragment: `
            in vec3 colorOut;
            out vec4 fragment;

            void main () {
              fragment = vec4(colorOut, 1.0);
            }
          `,
        });

        // Later
        // const framebufferTest = framebuffer({ color: [smallTexture] });

        return {
          frame: thisContext.frame,
          commands: { drawTriangle, drawQuad, clear: thisContext.clear },
          quadInstance,
          shared,
        };
      });

      const app = effect(() => {
        const { frame, commands, resources, quadInstance, shared } = graphics();
        const { clear, drawTriangle, drawQuad } = commands;

        frame(() => {
          clear();
          drawTriangle();
          drawTriangle("LINES");
          drawQuad();
        });

        for (let index = 1; index < 13; index++) {
          quad(index, quadInstance);
        }
      });

      const counter = state(0, (get, set) => ({ increment: () => set(get() + 1) }));

      const quad = effect((index, quadInstance) => {
        const [, { increment }] = counter();

        setTimeout(increment, Math.random() * 1000);

        quadInstance(index, {
          color: [Math.random(), Math.random(), Math.random()],
          offset: Float32Array.of(-index * 0.1, -index * 0.1),
        });
      });

      app();
    </script>
  </body>
</html>
